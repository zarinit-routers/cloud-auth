{% extends "base.html" %}

{% block content %}
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h2>
<a href="{{ url_for('create_group') }}" class="btn btn-primary mb-3">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</a>

<div class="row">
    <div class="col-md-6">
        <h4>–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø</h4>
        {% for group in groups %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ group.name }}</strong>
                    <span class="badge bg-secondary">{{ group.users|length }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                </div>
                <div>
                    <a href="{{ url_for('edit_group', group_id=group.id) }}" class="btn btn-sm btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="{{ url_for('delete_group', group_id=group.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')">–£–¥–∞–ª–∏—Ç—å</a>
                </div>
            </div>
            <div class="card-body">
                <p>{{ group.description }}</p>
                
                <!-- –ü–∞—Ä–æ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞ –≥—Ä—É–ø–ø—ã -->
                <div class="mb-3">
                    <label class="form-label"><strong>–ü–∞—Ä–æ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞ –≥—Ä—É–ø–ø—ã:</strong></label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password-{{ group.id }}" 
                               value="{{ group.password_phrase or '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="togglePassword('password-{{ group.id }}')">
                            üëÅÔ∏è
                        </button>
                        <button class="btn btn-outline-primary" type="button"
                                onclick="generateGroupPassword('{{ group.id }}')">
                            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        {% if group.password_phrase %}
                        <button class="btn btn-outline-danger" type="button"
                                onclick="clearGroupPassword('{{ group.id }}')">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        {% endif %}
                    </div>
                    <small class="form-text text-muted">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤ –∫ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ</small>
                </div>

                {% if group.users %}
                <h6>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –≥—Ä—É–ø–ø–µ:</h6>
                <ul class="list-group">
                    {% for user_group in group.users %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ user_group.user.username }}
                        <a href="{{ url_for('remove_user_from_group', user_group_id=user_group.id) }}" 
                           class="btn btn-sm btn-danger" 
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥—Ä—É–ø–ø—ã?')">
                            –£–¥–∞–ª–∏—Ç—å
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">–í –≥—Ä—É–ø–ø–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="col-md-6">
        <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É</h4>
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_user_to_group') }}">
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <select name="user_id" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.role }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ì—Ä—É–ø–ø–∞</label>
                        <select name="group_id" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
    } else {
        input.type = 'password';
    }
}

function generateGroupPassword(groupId) {
    const id = parseInt(groupId);
    if (confirm('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –ø–∞—Ä–æ–ª—å–Ω—É—é —Ñ—Ä–∞–∑—É? –°—Ç–∞—Ä–∞—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.')) {
        fetch('/admin/generate-group-password/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const input = document.getElementById('password-' + groupId);
                input.value = data.password;
                alert('–ù–æ–≤–∞—è –ø–∞—Ä–æ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—å–Ω–æ–π —Ñ—Ä–∞–∑—ã');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—å–Ω–æ–π —Ñ—Ä–∞–∑—ã');
        });
    }
}

function clearGroupPassword(groupId) {
    const id = parseInt(groupId);
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –ø–∞—Ä–æ–ª—å–Ω—É—é —Ñ—Ä–∞–∑—É?')) {
        fetch('/admin/clear-group-password/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const input = document.getElementById('password-' + groupId);
                input.value = '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                alert('–ü–∞—Ä–æ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–∞—Ä–æ–ª—å–Ω–æ–π —Ñ—Ä–∞–∑—ã');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–∞—Ä–æ–ª—å–Ω–æ–π —Ñ—Ä–∞–∑—ã');
        });
    }
}
</script>
{% endblock %}